<app-page-header
  [title]="'dashboard.title' | translate"
  [subtitle]="'dashboard.subtitle' | translate"
></app-page-header>

<div class="dashboard-layout">
  <app-filters-bar
    [rangeOptions]="rangeOptions"
    [umbralOptions]="umbralOptions"
    [inactiveOptions]="inactiveOptions"
    [(rangeDays)]="rangeDays"
    [(umbralDias)]="umbralDias"
    [(inactiveDays)]="inactiveDays"
    [(includePagadas)]="includePagadas"
    [(clienteSeleccionado)]="clienteSeleccionado"
    [clienteSuggestions]="clienteSuggestions"
    [showAction]="isAdmin"
    (searchClientes)="onSearchClientes($event)"
    (filtersChange)="updateFilters()"
    (actionClick)="resetDemoData()"
  ></app-filters-bar>

  <div *ngIf="dashboard$ | async as data">
  <section class="dashboard-section">
    <div class="grid">
      <div class="col-12 md:col-6 lg:col-3">
        <div class="stat-card">
          <p class="app-muted">{{ 'dashboard.carteraPendiente' | translate }}</p>
          <h2>{{ data.kpis.totalPendiente | currency:'COP':'symbol-narrow' }}</h2>
        </div>
      </div>
      <div class="col-12 md:col-6 lg:col-3">
        <div class="stat-card">
          <p class="app-muted">{{ 'dashboard.facturasVencidas' | translate }}</p>
          <h2>{{ data.kpis.facturasVencidas }}</h2>
        </div>
      </div>
      <div class="col-12 md:col-6 lg:col-3">
        <div class="stat-card">
          <p class="app-muted">{{ 'dashboard.facturasPorVencer' | translate }}</p>
          <h2>{{ data.kpis.facturasPorVencer }}</h2>
        </div>
      </div>
      <div class="col-12 md:col-6 lg:col-3">
        <div class="stat-card">
          <p class="app-muted">{{ 'reportes.totalVentas' | translate }}</p>
          <h2>{{ data.resumen.totalVentas | currency:'COP':'symbol-narrow' }}</h2>
        </div>
      </div>
    </div>
  </section>

  <section class="dashboard-section">
    <div class="section-header">
      <h3>{{ 'dashboard.carteraTitle' | translate }}</h3>
      <p class="app-muted">{{ 'dashboard.carteraSubtitle' | translate }}</p>
    </div>

    <div class="card-surface p-3 mb-3">
      <div class="section-subheader">
        <h4>{{ 'dashboard.creditosVencidos' | translate }}</h4>
        <span class="app-muted">
          {{ 'dashboard.facturasVencidas' | translate }}: {{ data.vencidos.length }}
        </span>
      </div>
      <p-table
        [value]="data.vencidos"
        [rows]="6"
        [paginator]="true"
        [rowHover]="true"
        responsiveLayout="scroll"
      >
        <ng-template pTemplate="header">
          <tr>
            <th>{{ 'dashboard.cliente' | translate }}</th>
            <th>{{ 'dashboard.factura' | translate }}</th>
            <th>{{ 'dashboard.diasVencidos' | translate }}</th>
            <th>{{ 'dashboard.vencimiento' | translate }}</th>
            <th>{{ 'dashboard.saldo' | translate }}</th>
            <th>{{ 'dashboard.acciones' | translate }}</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-row>
          <tr [ngClass]="rowClass(row)">
            <td>{{ row.cliente?.nombre || '-' }}</td>
            <td>{{ row.factura.consecutivo }}</td>
            <td>{{ row.daysOverdue }}</td>
            <td>{{ row.factura.fechaVencimiento | date:'shortDate' }}</td>
            <td>{{ row.factura.saldoPendiente | currency:'COP':'symbol-narrow' }}</td>
            <td>
              <button
                *ngIf="can('ventas:marcarPagada')"
                pButton
                type="button"
                class="p-button-text"
                (click)="openPayment(row)"
              >
                {{ 'dashboard.registrarPago' | translate }}
              </button>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="6" class="text-center app-muted p-4">
              {{ 'dashboard.sinVencidos' | translate }}
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>

    <div class="card-surface p-3 mb-3">
      <div class="section-subheader">
        <h4>{{ 'dashboard.creditosPorVencer' | translate }}</h4>
        <span class="app-muted">
          {{ 'dashboard.facturasPorVencer' | translate }}: {{ data.porVencer.length }}
        </span>
      </div>
      <p-table
        [value]="data.porVencer"
        [rows]="6"
        [paginator]="true"
        [rowHover]="true"
        responsiveLayout="scroll"
      >
        <ng-template pTemplate="header">
          <tr>
            <th>{{ 'dashboard.cliente' | translate }}</th>
            <th>{{ 'dashboard.factura' | translate }}</th>
            <th>{{ 'dashboard.venceEn' | translate }}</th>
            <th>{{ 'dashboard.vencimiento' | translate }}</th>
            <th>{{ 'dashboard.total' | translate }}</th>
            <th>{{ 'dashboard.saldo' | translate }}</th>
            <th>{{ 'dashboard.acciones' | translate }}</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-row>
          <tr [ngClass]="rowClass(row)">
            <td>{{ row.cliente?.nombre || '-' }}</td>
            <td>{{ row.factura.consecutivo }}</td>
            <td>{{ row.daysToDue }}</td>
            <td>{{ row.factura.fechaVencimiento | date:'shortDate' }}</td>
            <td>{{ row.factura.total | currency:'COP':'symbol-narrow' }}</td>
            <td>{{ row.factura.saldoPendiente | currency:'COP':'symbol-narrow' }}</td>
            <td>
              <button
                pButton
                type="button"
                class="p-button-text"
                [routerLink]="['/app/ventas/facturas', row.factura.id]"
              >
                {{ 'dashboard.ver' | translate }}
              </button>
              <button
                *ngIf="can('ventas:marcarPagada') && row.factura.saldoPendiente > 0"
                pButton
                type="button"
                class="p-button-text"
                (click)="markAsPaid(row)"
              >
                {{ 'cartera.marcarPagada' | translate }}
              </button>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="7" class="text-center app-muted p-4">
              {{ 'dashboard.sinCreditos' | translate }}
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>

    <div class="card-surface p-3">
      <div class="section-subheader">
        <h4>{{ 'dashboard.clientesCreditoVencido' | translate }}</h4>
        <span class="app-muted">
          {{ 'dashboard.clientes' | translate }}: {{ data.clientesVencidos.length }}
        </span>
      </div>
      <p-table
        [value]="data.clientesVencidos"
        [rows]="6"
        [paginator]="true"
        [rowHover]="true"
        responsiveLayout="scroll"
      >
        <ng-template pTemplate="header">
          <tr>
            <th>{{ 'dashboard.cliente' | translate }}</th>
            <th>{{ 'dashboard.facturasVencidas' | translate }}</th>
            <th>{{ 'dashboard.saldoVencido' | translate }}</th>
            <th>{{ 'dashboard.maxDiasVencidos' | translate }}</th>
            <th>{{ 'dashboard.ultimoVencimiento' | translate }}</th>
            <th>{{ 'dashboard.acciones' | translate }}</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-row>
          <tr>
            <td>{{ row.cliente.nombre }}</td>
            <td>{{ row.facturasVencidas }}</td>
            <td>{{ row.saldoVencido | currency:'COP':'symbol-narrow' }}</td>
            <td>{{ row.maxDiasVencidos }}</td>
            <td>{{ row.ultimoVencimiento | date:'shortDate' }}</td>
            <td>
              <button
                pButton
                type="button"
                class="p-button-text"
                (click)="filterByCliente(row.cliente)"
              >
                {{ 'dashboard.verCarteraCliente' | translate }}
              </button>
              <button
                *ngIf="can('ventas:marcarPagada')"
                pButton
                type="button"
                class="p-button-text"
                [disabled]="!row.facturaMasVencida"
                (click)="openPaymentForCliente(row)"
              >
                {{ 'dashboard.registrarPago' | translate }}
              </button>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="6" class="text-center app-muted p-4">
              {{ 'dashboard.sinVencidos' | translate }}
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </section>

  <section class="dashboard-section">
    <div class="section-header">
      <h3>{{ 'dashboard.clientesTitle' | translate }}</h3>
      <p class="app-muted">{{ 'dashboard.clientesSubtitle' | translate }}</p>
    </div>

    <div class="card-surface p-3 mb-3">
      <h4>{{ 'dashboard.topClientes' | translate }}</h4>
      <p-table
        [value]="data.topClientes"
        [rows]="6"
        [paginator]="true"
        [rowHover]="true"
        responsiveLayout="scroll"
      >
        <ng-template pTemplate="header">
          <tr>
            <th>{{ 'dashboard.cliente' | translate }}</th>
            <th>{{ 'dashboard.total' | translate }}</th>
            <th>{{ 'dashboard.compras' | translate }}</th>
            <th>{{ 'dashboard.ticketProm' | translate }}</th>
            <th>{{ 'dashboard.creditoPct' | translate }}</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-row>
          <tr>
            <td>{{ row.cliente.nombre }}</td>
            <td>{{ row.total | currency:'COP':'symbol-narrow' }}</td>
            <td>{{ row.count }}</td>
            <td>{{ row.promedio | currency:'COP':'symbol-narrow' }}</td>
            <td>{{ row.creditoPct | number:'1.0-0' }}%</td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="5" class="text-center app-muted p-4">
              {{ 'dashboard.sinTopClientes' | translate }}
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>

    <div class="card-surface p-3">
      <h4>{{ 'dashboard.inactivosTitle' | translate }}</h4>
      <p-table
        [value]="data.inactivos"
        [rows]="6"
        [paginator]="true"
        [rowHover]="true"
        responsiveLayout="scroll"
      >
        <ng-template pTemplate="header">
          <tr>
            <th>{{ 'dashboard.cliente' | translate }}</th>
            <th>{{ 'dashboard.ultimaCompra' | translate }}</th>
            <th>{{ 'dashboard.diasSinComprar' | translate }}</th>
            <th>{{ 'dashboard.acciones' | translate }}</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-row>
          <tr>
            <td>{{ row.cliente.nombre }}</td>
            <td>{{ row.lastPurchase | date:'shortDate' }}</td>
            <td>{{ row.daysInactive }}</td>
            <td>
              <button pButton type="button" class="p-button-text" routerLink="/app/ventas/factura-nueva">
                {{ 'dashboard.crearFactura' | translate }}
              </button>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="4" class="text-center app-muted p-4">
              {{ 'dashboard.sinInactivos' | translate }}
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </section>

  <section class="dashboard-section">
    <div class="section-header">
      <h3>{{ 'dashboard.resumenRango' | translate }}</h3>
    </div>
    <div class="grid">
      <div class="col-12 md:col-3">
        <div class="stat-card">
          <p class="app-muted">{{ 'reportes.totalVentas' | translate }}</p>
          <h3>{{ data.resumen.totalVentas | currency:'COP':'symbol-narrow' }}</h3>
        </div>
      </div>
      <div class="col-12 md:col-3">
        <div class="stat-card">
          <p class="app-muted">{{ 'reportes.totalCredito' | translate }}</p>
          <h3>{{ data.resumen.totalCredito | currency:'COP':'symbol-narrow' }}</h3>
        </div>
      </div>
      <div class="col-12 md:col-3">
        <div class="stat-card">
          <p class="app-muted">{{ 'reportes.totalContado' | translate }}</p>
          <h3>{{ data.resumen.totalContado | currency:'COP':'symbol-narrow' }}</h3>
        </div>
      </div>
      <div class="col-12 md:col-3">
        <div class="stat-card">
          <p class="app-muted">{{ 'dashboard.carteraPendiente' | translate }}</p>
          <h3>{{ data.resumen.totalCarteraPendiente | currency:'COP':'symbol-narrow' }}</h3>
        </div>
      </div>
    </div>
  </section>
  </div>
</div>

<p-dialog
  [(visible)]="paymentVisible"
  [modal]="true"
  [style]="{ width: '420px' }"
  [header]="'dashboard.registrarPago' | translate"
>
  <div *ngIf="paymentFactura" class="flex flex-column gap-3">
    <div>
      <strong>{{ paymentFactura.factura.consecutivo }}</strong>
      <p class="app-muted">{{ paymentFactura.cliente?.nombre || '-' }}</p>
    </div>
    <div class="flex flex-column gap-2">
      <label>{{ 'reportes.montoPago' | translate }}</label>
      <p-inputNumber [(ngModel)]="paymentAmount" [min]="1"></p-inputNumber>
    </div>
    <div class="flex justify-content-between">
      <span class="app-muted">{{ 'reportes.saldoActual' | translate }}</span>
      <strong>{{ paymentFactura.factura.saldoPendiente | currency:'COP':'symbol-narrow' }}</strong>
    </div>
  </div>
  <ng-template pTemplate="footer">
    <button pButton type="button" class="p-button-text" (click)="paymentVisible = false">
      {{ 'app.cancelar' | translate }}
    </button>
    <button pButton type="button" (click)="confirmPayment()">
      {{ 'app.guardar' | translate }}
    </button>
  </ng-template>
</p-dialog>
